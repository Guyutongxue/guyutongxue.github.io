<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title></title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <style>
        #userToken {
            width: 100%
        }
    </style>
</head>

<body>
    <div class="container">
        <noscript><div class="alert alert-danger">此浏览器不支持。</div></noscript>
        <h1>简单的查成绩页面</h1>
        下面这个被称作 User Token，每个学生唯一一份，是一个不太重要的“秘钥”，可以用来查成绩、上树洞
        <input type="text" value="" id="userToken">
        <button class="btn btn-primary btn-block" onclick="get()">获取成绩</button>
        <div>
        <h3>基本信息</h3>
        <ul>
            <li id="student">姓名</li>
            <li id="gpa">GPA</li>
        </ul>
        </div>
        <div id="tableContainer"></div>
    </div>
    <script>
        function get(){
            $("#tableContainer").children().remove();
            $.getJSON(`https://pkuhelper.pku.edu.cn/api_xmcp/isop/scores?user_token=${$('#userToken').val()}`).done(json => {
                const scores = json.cjxx;
                for (const i of scores) {
                    const xq = i.xndpx + "-" + i.xq;
                    if ($("#scoreTable-" + xq).length != 1)
                        $('#tableContainer').append(`
                        <h3>${i.xndpx} 学年度第 ${i.xq} 学期</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>课程名称</th>
                                    <th>成绩</th>
                                    <th>绩点</th>
                                </tr>
                            </thead>
                        <tbody id="scoreTable-${xq}"></tbody>
                        </table>`);
                    const tr = $("#scoreTable-" + xq).append("<tr>");
                    tr.append(`<td id="nameData">
                        <a target="_blank" href="https://elective.pku.edu.cn/elective2008/edu/pku/stu/elective/controller/courseDetail/getCourseDetail.do?kclx=BK&course_seq_no=${i.zxjhbh}">
                            ${i.kcmc}
                        </a>
                        <span class="text-black-50">（${/(?<=-).+?(?=\$)/.exec(i.skjsxm)[0]}）</span>
                    </td>`);
                    tr.append(`<td id="scoreData">${i.xqcj}</td>`);
                    tr.append(`<td id="gpData">${i.jd}</td>`);
                }
                const info = json.jbxx;
                $("#student").text(`${info.xm}（${info.xh}，${info.xsmc}/${info.zymc}）`);
                $("#gpa").text(`GPA: ${json.gpa.gpa}`);
            });
        }
    </script>
</body>

</html>